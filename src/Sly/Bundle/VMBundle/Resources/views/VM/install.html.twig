#!/usr/bin/env bash

BASE_SCRIPT_DIR="$PWD"
BASE_VAGRANT_DIR="$PWD/vagrant"

echo -e ""
echo -e "\033[32m __    __     _                   ___                          _             \033[0m"
echo -e "\033[32m/ / /\ \ \___| |__/\   /\/\/\    / _ \___ _ __   ___ _ __ __ _| |_ ___  _ __ \033[0m"
echo -e "\033[32m\ \/  \/ / _ \ '_ \ \ / /    \  / /_\/ _ \ '_ \ / _ \ '__/ _\` | __/ _ \| '__|\033[0m"
echo -e "\033[32m \  /\  /  __/ |_) \ V / /\/\ \/ /_\\  __/ | | |  __/ | | (_| | || (_) | |   \033[0m"
echo -e "\033[32m  \/  \/ \___|_.__/ \_/\/    \/\____/\___|_| |_|\___|_|  \__,_|\__\___/|_|   \033[0m"
echo -e ""
echo "- {{ project.version }} version -"
echo ""
echo "Generator service to make your Vagrant + Puppet web Virtual Machines easily."
echo ""
echo "By {{ author.name }} <{{ author.email }}>,"
echo "Website: {{ project.url }}"
echo "GitHub repository: {{ project.githubUrl }}"
echo ""
echo ""
echo -e "\033[33m-----------------------------------------\033[0m"
echo ""
echo -e "\033[33m        INSTALLATION IN PROGRESS...      \033[0m"
echo ""
echo -e "\033[33m-----------------------------------------\033[0m"
echo ""
echo ""

echo -e "\033[33m--> Grabbing generated Vagrant configuration...\033[0m"
echo ""
wget --no-check-certificate {{ url('vm_download_archive', { uKey: vm.uKey }) }} -O $BASE_SCRIPT_DIR/{{ vm.tempArchiveFilename }}
echo ""


echo -e "\033[33m--> Uncompacting downloaded archive...\033[0m"
echo ""
tar zxvf $BASE_SCRIPT_DIR/{{ vm.tempArchiveFilename }}
mv $BASE_SCRIPT_DIR/{{ vm.uKey }} $BASE_VAGRANT_DIR
echo ""

echo -e "\033[33m--> Grabbing {{ gitModules | length }} Git dependencie(s)...\033[0m"
echo ""
{% for gitModulePath, gitModuleUrl in gitModules %}
git clone {{ gitModuleUrl }} $BASE_VAGRANT_DIR/{{ gitModulePath }}
{% endfor %}
echo ""

echo -e "\033[33m--> Cleaning...\033[0m"
echo ""
rm $BASE_SCRIPT_DIR/{{ vm.tempArchiveFilename }}
rm -rf $BASE_VAGRANT_DIR/.git*
echo "Done."
echo ""

echo -e "\033[33m--> Vagrant box first launching...\033[0m"
echo ""
echo "BE PATIENT, BE PATIENT, BE PATIENT! :)"
cd $BASE_VAGRANT_DIR
echo ""
{% if vm.getVagrantFinalLaunch %}
vagrant up
echo ""
{% endif %}

echo -e "\033[33m--> Ready to go!\033[0m"
echo ""
echo "More informations and tips? See README file, present into your vagrant/ directory."
echo ""
